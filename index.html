<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DU DOCES — Distribuidora</title>

  <!-- SEO -->
  <link rel="canonical" href="https://du-doces.vercel.app/">
  <meta name="description" content="Du Doces Distribuidora — bebidas, chocolates, salgadinhos e mais com entrega rápida." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#C62828" />

  <!-- OG -->
  <meta property="og:site_name" content="DU DOCES" />
  <meta property="og:title" content="DU DOCES — Distribuidora" />
  <meta property="og:description" content="As melhores marcas com logística ágil." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://du-doces.vercel.app/" />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:image" content="https://du-doces.vercel.app/assets/og.jpg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="DU DOCES — Distribuidora" />
  <meta name="twitter:description" content="As melhores marcas com logística ágil." />
  <meta name="twitter:image" content="https://du-doces.vercel.app/assets/og.jpg" />

  <link rel="icon" href="/assets/favicon.ico" />
  <link rel="stylesheet" href="./assets/style.css?v=14" />

  <!-- bolha do ChatVolt sempre por cima -->
  <style>
    chatbox-bubble{ z-index: 2147483647 !important; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="topbar">
    <div class="topbar-left">
      <button class="icon-btn" id="btn-menu" aria-label="Abrir menu">
        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
      </button>
    </div>

    <a class="brand center" href="/" aria-label="DU DOCES">
      <span class="brand-du">DU</span><span class="brand-doces">DOCES</span>
      <span class="brand-sub">Distribuidora</span>
    </a>

    <div class="topbar-right">
      <input id="cep" class="input" placeholder="CEP" inputmode="numeric" />
      <button class="btn btn-light" id="btn-login">Login</button>
      <button class="icon-btn" id="btn-cart" aria-label="Carrinho">
        <svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M7 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm10 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4ZM3 3h2l2.4 10.3A2 2 0 0 0 9.35 15h7.9a2 2 0 0 0 1.96-1.58L21 7H6.42l-.5-2H3Z"/></svg>
        <span class="cart-badge" id="cart-count">0</span>
      </button>
    </div>
  </header>

  <!-- Banners -->
  <section class="banners" id="banners"></section>

  <!-- Barras fixas -->
  <nav class="sticky-bar" id="navCats">
    <div class="bar-scroll" id="catsBar"></div>
  </nav>
  <nav class="sticky-bar" id="navBrands">
    <div class="bar-scroll" id="brandsBar"></div>
  </nav>

  <main class="page">
    <section class="other-brands-box">
      <h3>Outras marcas</h3>
      <div class="brands-grid" id="otherBrands"></div>
    </section>

    <section class="filters">
      <div class="filters-row">
        <label>
          <span class="lbl">Ordenar</span>
          <select id="sort" class="select">
            <option value="relevance">Relevância</option>
            <option value="price-asc">Preço: menor &rarr; maior</option>
            <option value="price-desc">Preço: maior &rarr; menor</option>
            <option value="name-asc">Nome: A &rarr; Z</option>
          </select>
        </label>

        <label class="chk">
          <input type="checkbox" id="promoOnly" />
          <span>Somente promoções</span>
        </label>

        <button class="btn btn-outline" id="btn-clear">Limpar</button>
      </div>
    </section>

    <section class="products" id="productsGrid"></section>
  </main>

  <!-- IA -->
  <button class="fab-ia" id="btn-ia" title="IA">IA</button>

  <!-- Rodapé -->
  <footer class="footer">
    <div class="footer-inner">
      <p>Du Doces Distribuidora LTDA — todos os direitos reservados</p>
    </div>
    <div class="footer-accent"></div>
  </footer>

  <!-- Drawer menu -->
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-panel">
      <button class="icon-btn close" id="close-drawer" aria-label="Fechar">✕</button>
      <div class="drawer-header"><strong>Menu</strong></div>
      <nav class="drawer-nav">
        <button class="link-like" id="toggle-dark">🌙 Modo escuro</button>
        <button class="link-like" data-open="about">Sobre nós</button>
        <button class="link-like" data-open="contact">Contatos</button>
      </nav>
    </div>
  </aside>

  <!-- Drawer carrinho -->
  <aside class="drawer" id="cartDrawer" aria-hidden="true">
    <div class="drawer-panel">
      <button class="icon-btn close" id="cart-close" aria-label="Fechar">✕</button>
      <div class="drawer-header"><strong>Carrinho</strong></div>
      <div class="drawer-body">
        <div id="cart-items" class="cart-list"></div>
      </div>
      <div class="drawer-footer">
        <div class="cart-total">Total: <strong id="cart-total">R$ 0,00</strong></div>
        <div class="row gap8">
          <button class="btn btn-light" id="cart-clear">Limpar</button>
          <button class="btn" id="cart-checkout">Finalizar</button>
        </div>
      </div>
    </div>
  </aside>

  <!-- Modais -->
  <section class="modal" id="modal-about" aria-hidden="true">
    <div class="modal-dialog">
      <header>
        <h3>Sobre nós</h3>
        <button class="icon-btn modal-close" data-close>✕</button>
      </header>
      <div class="modal-body">
        <p>A Du Doces Distribuidora traz as melhores marcas com logística ágil e atendimento próximo.</p>
      </div>
      <footer><button class="btn btn-light" data-close>Fechar</button></footer>
    </div>
  </section>

  <section class="modal" id="modal-contact" aria-hidden="true">
    <div class="modal-dialog">
      <header>
        <h3>Contatos</h3>
        <button class="icon-btn modal-close" data-close>✕</button>
      </header>
      <div class="modal-body">
        <p>Email: atendimento@dudoces.com.br</p>
        <p>WhatsApp: (11) 99999-0000</p>
        <p>Endereço: Rua Exemplo, 123 — Campinas/SP</p>
      </div>
      <footer><button class="btn btn-light" data-close>Fechar</button></footer>
    </div>
  </section>

  <!-- Banners embutidos -->
  <script id="banners-data" type="application/json">
  [
    { "src": "https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?q=80&w=1600&auto=format&fit=crop", "href": "#" },
    { "src": "https://images.unsplash.com/photo-1542838132-92c53300491e?q=80&w=1600&auto=format&fit=crop" },
    { "src": "https://images.unsplash.com/photo-1452251889946-8ff5ea7b27ab?q=80&w=1600&auto=format&fit=crop" }
  ]
  </script>

  <!-- ===== JS EMBUTIDO ===== -->
  <script>
  // helpers
  const $ = (s)=>document.querySelector(s);
  const on = (el,ev,fn)=>el && el.addEventListener(ev,fn);

  // API base
  const API_BASE = (() => {
    const PROD = "https://du-doces-backend-production.up.railway.app";
    const DEV  = "http://localhost:8080";
    const h = location.hostname;
    if (h === "localhost" || h === "127.0.0.1") return DEV;
    return PROD;
  })();

  // utils
  const slug = (s) => String(s||"")
    .toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)+/g,'');
  const BRL = (v) => Number(v||0).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });

  // imagem segura (corrige domínios/caminhos + fallback)
  function safeImg(u){
    let s = String(u || '').trim();
    if (!s) return 'https://placehold.co/600x400?text=Du+Doces';
    if (s.startsWith('/images/')) s = s.replace('/images/', '/assets/images/');
    if (s.startsWith('images/'))  s = s.replace('images/',  '/assets/images/');

    // troca via.placeholder.com -> placehold.co
    try {
      const url = new URL(s, location.origin);
      if (url.hostname.includes('via.placeholder.com')) {
        const m = url.pathname.match(/(\d+)x(\d+)/);
        const w = m ? m[1] : '600';
        const h = m ? m[2] : '400';
        const text = url.searchParams.get('text') || 'Du Doces';
        s = `https://placehold.co/${w}x${h}?text=${encodeURIComponent(text)}`;
      }
    } catch {}

    if (s.endsWith('/padaria.png') || s.endsWith('padaria.png')) return '/assets/images/padaria.svg';
    if (/^https?:\/\//i.test(s) || s.startsWith('/')) return s;
    return 'https://placehold.co/600x400?text=Du+Doces';
  }

  // state
  let PRODUCTS = [];
  let activeCat = 'tudo';
  let activeBrand = null;
  let otherBrandsSelected = new Set();

  // elements
  const grid = $('#productsGrid');
  const sortSel = $('#sort');
  const promoOnly = $('#promoOnly');
  const btnClear = $('#btn-clear');

  // ---- Layout dynamic mount ----
  const CATS = [
    { key:'tudo',       label:'Tudo' },
    { key:'bebida',     label:'Bebida' },
    { key:'salgadinho', label:'Salgadinho' },
    { key:'chocolate',  label:'Chocolate' },
    { key:'utilidades', label:'Utilidades' },
    { key:'pipoca',     label:'Pipoca' },
    { key:'pacoca',     label:'Paçoca' }
  ];
  const MAIN_BRANDS = ['Coca-Cola','Fanta','Nestle','Arcor','OZ','Lacta','Baly','Santa Helena','Tang'];

  function mountBars(){
    $('#catsBar').innerHTML = CATS.map((c,i)=>`
      <button class="chip ${i===0?'active':''}" data-cat="${c.key}">${c.label}</button>
    `).join('');
    $('#brandsBar').innerHTML = MAIN_BRANDS.map(b=>`
      <button class="chip chip-brand" data-brand="${slug(b)}">${b}</button>
    `).join('');
  }

  function mountOtherBrands(brandsJson){
    let list = ['Freegells','Garoto','Pipper','Chita','Haribo','Fini','Peccin','Dori','Riclan'];
    if (brandsJson){
      if (Array.isArray(brandsJson)) list = brandsJson;
      if (brandsJson.others) list = brandsJson.others;
    }
    $('#otherBrands').innerHTML = list.map(b=>`
      <button class="chip" data-other-brand="${slug(b)}">${b}</button>
    `).join('');
  }

  // ---- Render grid ----
  function normalizeProduct(p){
    const brandName = p?.brand?.name ?? p?.brand ?? p?.marca ?? "";
    const catName   = p?.category?.name ?? p?.category ?? p?.categoria ?? p?.cat ?? "";
    const priceVal  = (p?.precoCentavos != null) ? (p.precoCentavos/100) : (p?.price ?? p?.preco ?? p?.valor ?? 0);
    const rawImg    = p?.imageUrl ?? p?.image ?? p?.img ?? '';
    const packType  = p?.pack_type ?? p?.packType ?? p?.unidade ?? p?.embalagem ?? '';
    const packSize  = p?.pack_size ?? p?.packSize ?? p?.qtd_por_fardo ?? p?.qtd ?? null;
    return {
      id:    p?.id ?? p?.codigo ?? crypto.randomUUID(),
      name:  p?.name ?? p?.nome ?? p?.titulo ?? 'Produto',
      brand: String(brandName),
      brandKey: slug(brandName),
      cat:   slug(catName),
      price: Number(priceVal),
      promo: Boolean(p?.promo ?? p?.promocao ?? p?.em_promocao ?? false),
      img:   safeImg(rawImg),
      packType: packType,
      packSize: packSize
    };
  }

  function render(list){
    if(!list.length){
      grid.innerHTML = `<p style="opacity:.7">Nenhum produto encontrado.</p>`;
      return;
    }
    grid.innerHTML = list.map(p=>`
      <article class="card">
        <img src="${p.img}" alt="${p.name}" onerror="this.src='https://placehold.co/300x300?text=Produto'">
        <div class="p16">
          <div class="title">${p.name}</div>
          <div class="brand">${p.brand}</div>
          <div class="row">
            <strong>${BRL(p.price)}</strong>
            <button class="btn btn-outline" data-add="${p.id}">Adicionar</button>
          </div>
          ${p.packType ? `<div class="meta">Emb.: ${p.packType}${p.packSize?` — ${p.packSize} un`:''}</div>`:''}
        </div>
      </article>
    `).join('');
  }

  // ---- Filters ----
  function applyFilters(){
    let list = [...PRODUCTS];

    if(activeCat !== 'tudo'){
      list = list.filter(p => (p.cat||'') === activeCat);
    }
    if(activeBrand){
      list = list.filter(p => p.brandKey === activeBrand);
    }
    if(otherBrandsSelected.size){
      list = list.filter(p => otherBrandsSelected.has(p.brandKey));
    }
    if(promoOnly.checked){
      list = list.filter(p => p.promo);
    }

    switch(sortSel.value){
      case 'price-asc': list.sort((a,b)=>a.price-b.price); break;
      case 'price-desc': list.sort((a,b)=>b.price-a.price); break;
      case 'name-asc': list.sort((a,b)=>a.name.localeCompare(b.name)); break;
      default: break;
    }
    render(list);
  }

  // ==== CARRINHO ====
  const CART_KEY = "du_cart";
  const Cart = {
    load() {
      try { return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); }
      catch { return []; }
    },
    save(items) {
      localStorage.setItem(CART_KEY, JSON.stringify(items));
      updateCartUI();
    },
    add(prod, qty = 1) {
      const items = Cart.load();
      const idx = items.findIndex((i) => i.id === prod.id);
      if (idx >= 0) items[idx].qty += qty;
      else items.push({ id: prod.id, name: prod.name, price: Number(prod.price), image: prod.img, qty });
      Cart.save(items);
    },
    remove(id) { Cart.save(Cart.load().filter((i) => i.id !== id)); },
    setQty(id, qty) {
      const n = Math.max(1, Number(qty||1));
      const items = Cart.load();
      const it = items.find((i) => i.id === id);
      if (!it) return;
      it.qty = n;
      Cart.save(items);
    },
    clear() { Cart.save([]); },
    total() { return Cart.load().reduce((s,i)=>s+i.price*i.qty,0); },
    count() { return Cart.load().reduce((s,i)=>s+i.qty,0); },
  };

  const cartDrawer = $('#cartDrawer');
  function openCart(){ cartDrawer?.classList.add('open'); }
  function closeCart(){ cartDrawer?.classList.remove('open'); }

  function updateCartUI() {
    const items = Cart.load();
    $('#cart-count').textContent = String(Cart.count());
    $('#cart-total').textContent = BRL(Cart.total());
    const wrap = $('#cart-items');
    if (!wrap) return;
    if (!items.length) { wrap.innerHTML = `<p style="opacity:.7">Seu carrinho está vazio.</p>`; return; }
    wrap.innerHTML = items.map(i => `
      <div class="cart-row">
        <img class="cart-thumb" src="${safeImg(i.image)}" alt="${i.name}" onerror="this.src='https://placehold.co/80x80?text=?'"/>
        <div class="cart-info">
          <div class="name">${i.name}</div>
          <div class="price">${BRL(i.price)} <small>&times; ${i.qty} = ${BRL(i.price*i.qty)}</small></div>
          <div class="qty">
            <button class="btn-ico dec" data-id="${i.id}">−</button>
            <input class="q" data-id="${i.id}" type="number" min="1" value="${i.qty}" />
            <button class="btn-ico inc" data-id="${i.id}">+</button>
          </div>
        </div>
        <button class="btn btn-light rm" data-id="${i.id}">Remover</button>
      </div>
    `).join('');
  }

  // events
  document.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip');

    if(chip?.dataset.cat){
      document.querySelectorAll('#catsBar .chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      activeCat = chip.dataset.cat;
      activeBrand = null;
      otherBrandsSelected.clear();
      document.querySelectorAll('[data-other-brand].active').forEach(c=>c.classList.remove('active'));
      applyFilters(); return;
    }

    if(chip?.dataset.brand){
      document.querySelectorAll('#brandsBar .chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      activeBrand = chip.dataset.brand;
      activeCat = 'tudo';
      otherBrandsSelected.clear();
      document.querySelectorAll('[data-other-brand].active').forEach(c=>c.classList.remove('active'));
      applyFilters(); return;
    }

    if(chip?.dataset.otherBrand){
      const key = chip.dataset.otherBrand;
      chip.classList.toggle('active');
      if(chip.classList.contains('active')) otherBrandsSelected.add(key);
      else otherBrandsSelected.delete(key);
      activeBrand = null;
      applyFilters(); return;
    }

    if(e.target.matches('[data-add]')){
      const id = e.target.getAttribute('data-add');
      const prod = PRODUCTS.find(p => p.id === id);
      if (prod) { Cart.add(prod, 1); openCart(); }
      return;
    }

    if (e.target.matches('#btn-cart')) { openCart(); return; }
    if (e.target.matches('#cart-close')) { closeCart(); return; }
    if (e.target.id === 'cartDrawer' && e.target.classList.contains('drawer')) { closeCart(); return; }

    if (e.target.matches('.rm')) { Cart.remove(e.target.dataset.id); return; }
    if (e.target.matches('.inc')) {
      const id = e.target.dataset.id;
      const it = Cart.load().find(i=>i.id===id);
      Cart.setQty(id, (it?.qty||1)+1); return;
    }
    if (e.target.matches('.dec')) {
      const id = e.target.dataset.id;
      const it = Cart.load().find(i=>i.id===id);
      Cart.setQty(id, Math.max(1,(it?.qty||1)-1)); return;
    }
  });

  document.addEventListener('input', (e)=>{
    if(e.target === sortSel || e.target === promoOnly){ applyFilters(); }
    if (e.target.matches('.q')) { Cart.setQty(e.target.dataset.id, Number(e.target.value||1)); }
  });

  on(btnClear,'click', ()=>{
    promoOnly.checked = false;
    sortSel.value = 'relevance';
    document.querySelectorAll('.chip.active').forEach(c=>c.classList.remove('active'));
    document.querySelector('[data-cat="tudo"]')?.classList.add('active');
    activeCat = 'tudo'; activeBrand = null; otherBrandsSelected.clear();
    document.querySelectorAll('[data-other-brand].active').forEach(c=>c.classList.remove('active'));
    applyFilters();
  });

  // Drawer & modais
  on($('#btn-menu'),'click', ()=>$('#drawer').classList.add('open'));
  on($('#close-drawer'),'click', ()=>$('#drawer').classList.remove('open'));
  on($('#drawer'),'click', (e)=>{ if(e.target.id==='drawer') e.currentTarget.classList.remove('open'); });
  document.querySelectorAll('[data-open]').forEach(btn=>{
    on(btn,'click', ()=>{ $('#drawer').classList.remove('open'); $('#modal-'+btn.getAttribute('data-open'))?.classList.add('open'); });
  });
  document.querySelectorAll('[data-close]').forEach(btn=>{ on(btn,'click', ()=>btn.closest('.modal').classList.remove('open')); });
  document.querySelectorAll('.modal').forEach(m=>{ on(m,'click', (e)=>{ if(e.target.classList.contains('modal')) m.classList.remove('open'); }); });

  /* ===== CARROSSEL ===== */
  function initCarousel(root, { autoplay = 5000, pauseOnHover = true } = {}) {
    const track = root.querySelector('.carousel-track');
    const slides = Array.from(root.querySelectorAll('.carousel-slide'));
    const dotsWrap = root.querySelector('.carousel-dots');
    const prevBtn = root.querySelector('.prev');
    const nextBtn = root.querySelector('.next');
    if (!track || !slides.length) return;

    dotsWrap.innerHTML = slides.map((_, i) =>
      `<button class="carousel-dot" data-i="${i}" aria-label="Ir para slide ${i+1}"></button>`
    ).join('');
    const dots = Array.from(dotsWrap.children);

    let idx = 0, timer;
    function activate(i) { dots.forEach((d, j) => d.classList.toggle('active', j === i)); }
    function goTo(i, smooth = true) {
      idx = (i + slides.length) % slides.length;
      const x = root.clientWidth * idx;
      track.scrollTo({ left: x, behavior: smooth ? 'smooth' : 'instant' });
      activate(idx);
    }
    prevBtn?.addEventListener('click', () => goTo(idx - 1));
    nextBtn?.addEventListener('click', () => goTo(idx + 1));
    dots.forEach(d => d.addEventListener('click', () => goTo(+d.dataset.i)));
    track.addEventListener('scroll', () => {
      const w = root.clientWidth || 1;
      const near = Math.round(track.scrollLeft / w);
      if (near !== idx) { idx = near; activate(idx); }
    }, { passive: true });
    root.tabIndex = 0;
    root.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') goTo(idx + 1);
      if (e.key === 'ArrowLeft')  goTo(idx - 1);
    });
    function start() { if (autoplay > 0) timer = setInterval(() => goTo(idx + 1), autoplay); }
    function stop()  { clearInterval(timer); }
    if (pauseOnHover) { root.addEventListener('mouseenter', stop); root.addEventListener('mouseleave', start); }
    window.addEventListener('resize', () => goTo(idx, false));
    goTo(0, false);
    start();
  }

  // Banners
  async function loadBanners(){
    const ts = Date.now();
    try {
      const el = document.getElementById('banners-data');
      if (el && el.textContent?.trim()) {
        const items = JSON.parse(el.textContent);
        return mountCarousel(items);
      }
    } catch (e) { console.warn('Banners embutidos inválidos:', e); }

    try{
      const r = await fetch(`/assets/banners.json?ts=${ts}`, { cache:'no-store' });
      if (!r.ok) throw new Error(r.status);
      const items = await r.json();
      return mountCarousel(items);
    }catch{}

    try{
      const r = await fetch(`https://raw.githubusercontent.com/pahen77/Du-Doces/main/assets/banners.json?ts=${ts}`, { cache:'no-store' });
      if (!r.ok) throw new Error(r.status);
      const items = await r.json();
      return mountCarousel(items);
    }catch{}

    return mountCarousel([
      { src: "https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?q=80&w=1600&auto=format&fit=crop" },
      { src: "https://images.unsplash.com/photo-1542838132-92c53300491e?q=80&w=1600&auto=format&fit=crop" },
      { src: "https://images.unsplash.com/photo-1452251889946-8ff5ea7b27ab?q=80&w=1600&auto=format&fit=crop" }
    ]);

    function mountCarousel(items){
      const slides = (items||[]).map((b,i)=>{
        const src  = typeof b === 'string' ? b : (b.src || b.image || b.url || '');
        const href = typeof b === 'object' ? (b.href || b.link || null) : null;
        const alt  = typeof b === 'object' ? (b.alt  || `banner ${i+1}`) : `banner ${i+1}`;
        const img  = `<img src="${src}" loading="lazy" alt="${alt}" onerror="this.style.display='none'">`;
        return `<div class="carousel-slide">${href ? `<a href="${href}">${img}</a>` : img}</div>`;
      }).join('');
      $('#banners').innerHTML = `
        <div class="carousel" id="hero-carousel" aria-roledescription="carousel">
          <div class="carousel-track">${slides}</div>
          <div class="carousel-nav">
            <button class="carousel-btn prev" aria-label="Anterior"><</button>
            <button class="carousel-btn next" aria-label="Próximo">></button>
          </div>
          <div class="carousel-dots" aria-label="Slides"></div>
        </div>`;
      initCarousel($('#hero-carousel'), { autoplay: 4500, pauseOnHover: true });
    }
  }

  // Data
  async function loadData(){
    try{
      const res = await fetch(`${API_BASE}/products`, { cache:'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const items = Array.isArray(data) ? data : (data.items ?? data.data ?? []);
      PRODUCTS = (Array.isArray(items)?items:[]).map(normalizeProduct);

      const mainSet = new Set(MAIN_BRANDS.map(b=>slug(b)));
      const allBrands = [...new Set(PRODUCTS.map(p => p.brand).filter(Boolean))];
      const others = allBrands.filter(b => !mainSet.has(slug(b)));
      mountOtherBrands({ others });
    }catch(e){
      console.warn('API falhou, usando JSON local. Detalhe:', e?.message || e);
      try{
        const [prods, brands] = await Promise.all([
          fetch(`./assets/products.json?ts=${Date.now()}`).then(r=>r.json()),
          fetch(`./assets/brands.json?ts=${Date.now()}`).then(r=>r.json()).catch(()=>null)
        ]);
        PRODUCTS = (Array.isArray(prods)?prods:[]).map(normalizeProduct);
        mountOtherBrands(brands);
      }catch{
        PRODUCTS = [
          { id:1, name:"Bala Hortelã", brand:"Arcor", cat:"bala", price:2.99, promo:true,  img:"" },
          { id:2, name:"Chocolate Ao Leite 90g", brand:"Nestle", cat:"chocolate", price:7.49, promo:false, img:"" },
          { id:3, name:"Refrigerante Lata 350ml", brand:"Coca-Cola", cat:"salgadinho", price:4.99, promo:true,  img:"" }
        ].map(normalizeProduct);
        mountOtherBrands(null);
      }
    }
    applyFilters();
  }

  </script>

  <!-- ===== ChatVolt Bubble — local + fallback CDNs ===== -->
  <script type="module">
    const AGENT_ID = 'cmfk2a6ko0w5htglbf0n10833';

    async function tryImport(url) {
      console.log('[ChatVolt] tentando importar:', url);
      try {
        const m = await import(url);
        console.log('[ChatVolt] import OK:', url);
        return m;
      } catch (e) {
        console.error('[ChatVolt] falhou import:', url, e);
        return null;
      }
    }

    // 1) tenta carregar local (publique em /public/vendor/chatvolt/index.js)
    let mod = await tryImport('/vendor/chatvolt/index.js');

    // 2) fallbacks
    if (!mod) {
      const urls = [
        'https://cdn.jsdelivr.net/npm/@chatvolt/embeds@latest/dist/chatbox/index.js',
        'https://unpkg.com/@chatvolt/embeds@latest/dist/chatbox/index.js',
        'https://esm.sh/@chatvolt/embeds@latest/dist/chatbox/index.js'
      ];
      for (const u of urls) {
        mod = await tryImport(u);
        if (mod) break;
      }
    }

    async function wireBtnFallback(msg) {
      const old = document.getElementById('btn-ia');
      if (!old) return;
      const clone = old.cloneNode(true);
      old.replaceWith(clone);
      clone.addEventListener('click', () => alert(msg));
    }

    if (!mod || !mod.default || !mod.default.initBubble) {
      console.error('[ChatVolt] não foi possível carregar o módulo do widget.');
      wireBtnFallback('IA indisponível (falha ao carregar o widget).');
    } else {
      try {
        const widget = await mod.default.initBubble({ agentId: AGENT_ID });
        console.log('[ChatVolt] bubble iniciado:', !!widget);

        // botão “IA” abre a bolha
        const old = document.getElementById('btn-ia');
        if (old) {
          const clone = old.cloneNode(true);
          old.replaceWith(clone);
          clone.addEventListener('click', () => {
            document.querySelector('chatbox-bubble')?.click();
          });
          console.log('[ChatVolt] botão IA conectado.');
        }
      } catch (e) {
        console.error('[ChatVolt] initBubble falhou:', e);
        wireBtnFallback('IA indisponível (erro ao iniciar o widget).');
      }
    }
  </script>
  <!-- ===== /ChatVolt ===== -->

  <script>
  // boot
  document.addEventListener('DOMContentLoaded', ()=>{
    mountBars();
    loadBanners();
    updateCartUI();
    loadData();
  });

  // carrinho actions
  on($('#cart-clear'), 'click', ()=> Cart.clear());
  on($('#cart-checkout'), 'click', ()=>{
    alert('Checkout básico entra na Semana 3 😉\nResumo: ' + Cart.count() + ' item(ns) — ' + $('#cart-total').textContent);
  });
  </script>
  <!-- ===== /JS EMBUTIDO ===== -->

  <noscript>Ative o JavaScript para ver os produtos e o carrossel.</noscript>
</body>
</html>
